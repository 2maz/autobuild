#! /usr/bin/ruby

require 'daemons'
require 'autobuild'

include Autobuild

DEFAULT_HTTP_PORT = 2000

# Load the command line options
conffile, *targets = Autobuild.commandline(ARGV)

# make conffile an absolute path since daemonize mode makes
# / the current directory
conffile = File.expand_path(conffile, Dir.pwd)
if Autobuild.daemonize
    puts "Going into daemon mode ..."
    Daemons.daemonize 
end

Reporting << StdoutReporter.new
begin
    Reporting.report do
        load File.join('.', File.basename(conffile))
        Autobuild::TARGETS.each do |target|
            if !Config.respond_to?("do_#{target}") || Config.send("do_#{target}")
                if targets.empty?
                    Rake::Task[target].invoke
                else
                    targets.each do |pkg|
                        Rake::Task["#{pkg}-#{target}"].invoke
                    end
                end
            end
        end
        Reporting.success
    end
rescue Interrupt
end
 
