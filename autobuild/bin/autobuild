#! /usr/bin/ruby

require 'daemons'
require 'autobuild'

include Autobuild

DEFAULT_HTTP_PORT = 2000

# Load the command line options
conffile, *packages = Autobuild.commandline(ARGV)

# make conffile an absolute path since daemonize mode makes
# / the current directory
conffile = File.expand_path(conffile, Dir.pwd)
if Autobuild.daemonize
    puts "Going into daemon mode ..."
    Daemons.daemonize 
end

Reporting << StdoutReporter.new
begin
    Reporting.report do
        load conffile
        ['import', 'prepare', 'build'].each do |phase|
            if packages.empty?
                Rake::Task[phase].invoke
            else
                packages.each do |pkg|
                    Rake::Task["#{pkg}-#{phase}"].invoke
                end
            end
        end

        Reporting.success
    end
rescue Interrupt
end
 
